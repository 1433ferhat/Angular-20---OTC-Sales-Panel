<!-- src/app/components/customer-selection/customer-selection.html -->
<div class="customer-dialog">
    <h2 mat-dialog-title>
        <mat-icon>people</mat-icon>
        Müşteri Seçimi
    </h2>

    <mat-dialog-content>
        <mat-tab-group [(selectedIndex)]="selectedTabIndex">

            <!-- Mevcut Müşteriler Tab -->
            <mat-tab label="Müşteri Seç">
                <div class="tab-content">
                    <!-- Arama -->
                    <mat-form-field appearance="outline" class="search-field">
                        <mat-label>Müşteri Ara</mat-label>
                        <input matInput [(ngModel)]="searchQuery" placeholder="Ad, telefon, e-posta ile ara"
                            autocomplete="off">
                        <mat-icon matPrefix>search</mat-icon>
                        @if (searchQuery()) {
                        <button matSuffix mat-icon-button (click)="searchQuery.set('')" matTooltip="Temizle">
                            <mat-icon>clear</mat-icon>
                        </button>
                        }
                    </mat-form-field>

                    <!-- Müşteri Listesi -->
                    <div class="customer-list">
                        @if (filteredCustomers().length === 0 && !searchQuery()) {
                        <div class="no-customers">
                            <mat-icon>person_add</mat-icon>
                            <h3>Henüz müşteri yok</h3>
                            <p>İlk müşterinizi eklemek için "Yeni Müşteri" sekmesini kullanın</p>
                            <button mat-raised-button color="primary" (click)="selectedTabIndex.set(1)">
                                <mat-icon>add</mat-icon>
                                Yeni Müşteri Ekle
                            </button>
                        </div>
                        } @else if (filteredCustomers().length === 0 && searchQuery()) {
                        <div class="no-results">
                            <mat-icon>search_off</mat-icon>
                            <h3>Sonuç bulunamadı</h3>
                            <p>"{{ searchQuery() }}" için müşteri bulunamadı</p>
                            <button mat-button (click)="searchQuery.set('')">
                                Aramayı Temizle
                            </button>
                        </div>
                        } @else {
                        <div class="customer-list-container">
                            @for (customer of filteredCustomers(); track customer.id) {
                            <mat-card class="customer-card" (click)="selectExistingCustomer(customer)">
                                <mat-card-content>
                                    <div class="customer-header">
                                        <div class="customer-main-info">
                                            <h3>{{ getCustomerDisplayName(customer) }}</h3>
                                            <div class="customer-badges">
                                                <span class="customer-type-badge" [class.individual]="customer.tcNo"
                                                    [class.corporate]="!customer.tcNo">
                                                    {{ customer.tcNo ? 'Bireysel' : 'Kurumsal' }}
                                                </span>
                                                <span class="price-type-badge">
                                                    {{ getPriceTypeLabel(customer.type) }}
                                                </span>
                                            </div>
                                        </div>
                                        <mat-icon class="select-icon">arrow_forward_ios</mat-icon>
                                    </div>

                                    <div class="customer-details">
                                        <div class="detail-item">
                                            <mat-icon>phone</mat-icon>
                                            <span>{{ formatPhoneNumber(customer.phone) }}</span>
                                        </div>
                                        <div class="detail-item">
                                            <mat-icon>email</mat-icon>
                                            <span>{{ customer.email }}</span>
                                        </div>
                                        @if (customer.tcNo) {
                                        <div class="detail-item">
                                            <mat-icon>badge</mat-icon>
                                            <span>T.C.: {{ customer.tcNo }}</span>
                                        </div>
                                        }
                                        @if (customer.taxNumber) {
                                        <div class="detail-item">
                                            <mat-icon>business</mat-icon>
                                            <span>{{ customer.companyName }} - {{ customer.taxNumber }}</span>
                                        </div>
                                        }
                                    </div>
                                </mat-card-content>
                            </mat-card>
                            }
                        </div>
                        }
                    </div>
                </div>
            </mat-tab>

            <!-- Yeni Müşteri Tab -->
            <mat-tab label="Yeni Müşteri">
                <div class="tab-content">
                    <form class="customer-form">
                        <!-- Temel Bilgiler -->
                        <div class="form-section">
                            <h3 class="section-title">
                                <mat-icon>person</mat-icon>
                                Temel Bilgiler
                            </h3>

                            <div class="form-row two-column">
                                <mat-form-field appearance="outline">
                                    <mat-label>Ad *</mat-label>
                                    <input matInput [(ngModel)]="customerData.firstName" name="firstName" required>
                                    <mat-icon matPrefix>person</mat-icon>
                                </mat-form-field>

                                <mat-form-field appearance="outline">
                                    <mat-label>Soyad *</mat-label>
                                    <input matInput [(ngModel)]="customerData.lastName" name="lastName" required>
                                </mat-form-field>
                            </div>

                            <div class="form-row two-column">
                                <mat-form-field appearance="outline">
                                    <mat-label>Telefon *</mat-label>
                                    <input matInput [(ngModel)]="customerData.phone" name="phone" required type="tel"
                                        placeholder="0555 123 45 67">
                                    <mat-icon matPrefix>phone</mat-icon>
                                </mat-form-field>

                                <mat-form-field appearance="outline">
                                    <mat-label>E-Posta *</mat-label>
                                    <input matInput type="email" [(ngModel)]="customerData.email" name="email" required>
                                    <mat-icon matPrefix>email</mat-icon>
                                </mat-form-field>
                            </div>

                            <div class="form-row">
                                <mat-form-field appearance="outline" class="full-width">
                                    <mat-label>Fiyat Tipi *</mat-label>
                                    <mat-select [(ngModel)]="customerData.type" name="type" required>
                                        <mat-option *ngFor="let option of getPriceTypeOptions()" [value]="option.value">
                                            {{ option.label }}
                                        </mat-option>
                                    </mat-select>
                                    <mat-icon matPrefix>local_offer</mat-icon>
                                </mat-form-field>
                            </div>
                        </div>

                        <mat-divider></mat-divider>

                        <!-- Müşteri Tipi -->
                        <div class="form-section">
                            <h3 class="section-title">
                                <mat-icon>business</mat-icon>
                                Müşteri Tipi
                            </h3>

                            <mat-radio-group [(ngModel)]="isCorporate" name="customerType"
                                (change)="onCustomerTypeChange()" class="customer-type-radio">
                                <mat-radio-button [value]="false" class="customer-type-option">
                                    <div class="radio-content">
                                        <mat-icon>person</mat-icon>
                                        <div>
                                            <strong>Bireysel</strong>
                                            <p>T.C. Kimlik No ile</p>
                                        </div>
                                    </div>
                                </mat-radio-button>

                                <mat-radio-button [value]="true" class="customer-type-option">
                                    <div class="radio-content">
                                        <mat-icon>business</mat-icon>
                                        <div>
                                            <strong>Kurumsal</strong>
                                            <p>Vergi No ile</p>
                                        </div>
                                    </div>
                                </mat-radio-button>
                            </mat-radio-group>

                            <!-- Bireysel Müşteri -->
                            @if (!isCorporate()) {
                            <div class="form-row">
                                <mat-form-field appearance="outline" class="full-width">
                                    <mat-label>T.C. Kimlik No *</mat-label>
                                    <input matInput [(ngModel)]="customerData.tcNo" name="tcNo" maxlength="11"
                                        pattern="[0-9]*" required placeholder="12345678901">
                                    <mat-icon matPrefix>badge</mat-icon>
                                    <mat-hint>11 haneli T.C. Kimlik Numarası</mat-hint>
                                </mat-form-field>
                            </div>
                            }

                            <!-- Kurumsal Müşteri -->
                            @if (isCorporate()) {
                            <div class="form-row">
                                <mat-form-field appearance="outline" class="full-width">
                                    <mat-label>Şirket Adı *</mat-label>
                                    <input matInput [(ngModel)]="customerData.companyName" name="companyName" required>
                                    <mat-icon matPrefix>business</mat-icon>
                                </mat-form-field>
                            </div>

                            <div class="form-row">
                                <mat-form-field appearance="outline" class="full-width">
                                    <mat-label>Vergi No *</mat-label>
                                    <input matInput [(ngModel)]="customerData.taxNumber" name="taxNumber" maxlength="10"
                                        pattern="[0-9]*" required placeholder="1234567890">
                                    <mat-icon matPrefix>receipt</mat-icon>
                                    <mat-hint>10 haneli Vergi Numarası</mat-hint>
                                </mat-form-field>
                            </div>
                            }
                        </div>

                        <mat-divider></mat-divider>

                        <!-- E-Fatura -->
                        <div class="form-section">
                            <mat-checkbox [(ngModel)]="customerData.isEInvoice" name="isEInvoice"
                                class="einvoice-checkbox">
                                <div class="checkbox-content">
                                    <strong>E-Fatura</strong>
                                    <p>Bu müşteri e-fatura kullanıyor</p>
                                </div>
                            </mat-checkbox>
                        </div>
                    </form>
                </div>
            </mat-tab>
        </mat-tab-group>
    </mat-dialog-content>

    <mat-dialog-actions align="end">
        @if (selectedTabIndex() === 0) {
        <button mat-button (click)="onCancel()">
            <mat-icon>close</mat-icon>
            İptal
        </button>
        } @else {
        <button mat-button (click)="onCancel()">
            <mat-icon>close</mat-icon>
            İptal
        </button>
        <button mat-raised-button color="primary" (click)="saveNewCustomer()" [disabled]="!isFormValid()">
            <mat-icon>save</mat-icon>
            Kaydet
        </button>
        }
    </mat-dialog-actions>
</div>